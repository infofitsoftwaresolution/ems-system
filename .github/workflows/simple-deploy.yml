name: Simple Deploy

# DISABLED - Using "Deploy to EC2 with RDS" workflow instead
on:
  workflow_dispatch:  # Only manual trigger, not on push

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          # Update the application
          cd /opt/ems-deployment || (sudo mkdir -p /opt/ems-deployment && sudo chown ec2-user:ec2-user /opt/ems-deployment && cd /opt/ems-deployment)
          
          # Pull latest changes
          git pull origin main || git clone https://github.com/infofitsoftwaresolution/ems-system.git .
          
          # Install Docker if not installed
          if ! command -v docker &> /dev/null; then
            sudo dnf install -y docker
            sudo systemctl enable docker
            sudo systemctl start docker
            sudo usermod -a -G docker ec2-user
          fi
          
          # Install Docker Compose if not installed
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          fi
          
          # Deploy the application
          sudo docker-compose down || true
          sudo docker-compose up -d --build
          
          # Wait for services to start
          sleep 30
          
          # Health check
          curl -f http://localhost/api/health || echo "Health check failed, but deployment completed"
